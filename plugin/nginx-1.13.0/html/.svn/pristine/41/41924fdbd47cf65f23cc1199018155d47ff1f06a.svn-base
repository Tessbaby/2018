'use strict';

angular.module('app')
	.controller('activityController', ['$rootScope', '$scope', '$http', '$state', 'toaster',
	                                function ($rootScope, $scope, $http, $state, toaster) {

	                                    $scope.title = '群团活动';

	                                    $scope.param = {};
	                                    $scope.param.type = "1";
	                                    $scope.url = '/iBase4J-SYS-Web/activity/list';
	                                    $rootScope.search($scope.url, $scope.param);

	                                    //党组织结构设置
	                                    var setting = {
	                                        check: {
	                                            enable: true
	                                        },
	                                        data: {
	                                            key: {
	                                                id: "id",
	                                                children: "children",
	                                                name: "deptName"
	                                            }
	                                        },
	                                        callback: {
	                                            //beforeClick: beforeClick,
	                                            onCheck: onCheck
	                                        }
	                                    };
	                                    //包含下级
	                                    function setCheck() {
	                                        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                                            sy = $("#sy").prop("checked");
	                                        var type;
	                                        if (sy) {
	                                            type = { "Y": "s", "N": "s" };
	                                        } else {
	                                            type = { "Y": "", "N": "" };
	                                        }
	                                        //console.log(type);
	                                        zTree.setting.check.chkboxType = type;
	                                    }
	                                    //获取选中子级
	                                    function onCheck(e, treeId, treeNode) {
	                                        var arrNodes = new Array();
	                                        var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
                                            nodes = treeObj.getCheckedNodes(true);
	                                        for (var i = 0; i < nodes.length; i++) {
	                                            arrNodes.push(nodes[i].id);
	                                        }
	                                        $scope.param.sendDeptId = arrNodes.join(",");
	                                        //console.log($scope.param.sendDeptId);
	                                        $rootScope.search($scope.url, $scope.param);
	                                    }
	                                    //点击文字选中复选框
	                                    function beforeClick(treeId, treeNode) {
	                                        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	                                        zTree.checkNode(treeNode, !treeNode.checked, null, true);
	                                        return false;
	                                    }
	                                    //党组织结构树
	                                    $.ajax({
	                                        type: 'PUT',
	                                        dataType: 'json',
	                                        contentType: 'application/json;charset=UTF-8',
	                                        url: '/iBase4J-SYS-Web/dept/read/treelist',
	                                        data: ''
	                                    }).then(function (result) {
	                                        $scope.loading = false;
	                                        if (result.httpCode == 200) {
	                                            //console.log(result);
	                                            var zNodes = result.dept;
	                                            var treeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
	                                            treeObj.expandAll(true);
	                                            setCheck();
	                                            $("#sy").bind("change", setCheck);
	                                        } else {
	                                            $scope.msg = result.msg;
	                                        }
	                                        $scope.$apply();
	                                    });


	                                    $scope.clearSearch = function () {
	                                        $scope.param.keyword = null;
	                                        $rootScope.search($scope.url, $scope.param);
	                                    }

	                                    // 翻页 - 排序翻页数据与此一致
	                                    $scope.pagination = function (page) {
	                                        $scope.param.pageNum = page;
	                                        $scope.param.asc = $rootScope.changeAsc();
	                                        $rootScope.search($scope.url, $scope.param);
	                                    };

	                                }]);