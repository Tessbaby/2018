'use strict';

angular.module('app')
	.controller('hbListController', ['$rootScope', '$scope', '$http', '$state', 'toaster', '$timeout',
	      function ($rootScope, $scope, $http, $state, toaster, $timeout) {
	          $scope.title = '工作汇报';

	          //=======================================验证权限 statr===================================
	          //权限模块代码
	          $scope.permissionCode = $state.$current.name;
	          $scope.hasQuery = $.inArray($scope.permissionCode + '.query', $rootScope.permissionList) != -1;
	          $scope.hasQeurysub = $.inArray($scope.permissionCode + '.qeurysub', $rootScope.permissionList) != -1;
	          $scope.hasUpdate = $.inArray($scope.permissionCode + '.update', $rootScope.permissionList) != -1;
	          $scope.hasDelete = $.inArray($scope.permissionCode + '.delete', $rootScope.permissionList) != -1;
	          //=======================================验证权限 end===================================
	          if (!$scope.hasQuery) {
	              layer.alert("未经授权，禁止访问！", { icon: 2 });
	              return false;
	          }
	          //else {

	          //==================================执行查询 start==================================
	          $scope.param = {};
	          $scope.url = '/iBase4J-SYS-Web/report/list';
	          $rootScope.pageInfo = []; // 请求数据前清空
	          $scope.user = {};
	          $scope.upLeaderSel = '';
	          $scope.param.tab = 1;
	          $rootScope.search($scope.url, $scope.param);

	          $scope.clearSearch = function () {
	              $scope.param.keyword = null;
	              $rootScope.search($scope.url, $scope.param);
	          }

	          // 翻页 - 排序翻页数据与此一致
	          $scope.pagination = function (page) {
	              $scope.param.pageNum = page;
	              $scope.param.asc = $rootScope.changeAsc();
	              $rootScope.search($scope.url, $scope.param);
	          };
	          //==================================执行查询 end==================================

	          //上下级切换
	          $scope.changeHeader = function () {
	              console.log($scope.upLeaderSel);
	              //if($scope.upLeaderSel==2){
	              $state.go('main.party.report');
	              //}			
	          }	     


	          //删除
	          $scope.delInfo = function (id) {
	              $scope.loading = true;
	              if (confirm('确认要删除？')) {
	                  $scope.loading = true;
	                  $.ajax({
	                      type: 'post',
	                      dataType: 'json',
	                      contentType: 'application/json;charset=UTF-8',
	                      url: '/iBase4J-SYS-Web/report/delete',
	                      data: angular.toJson({ "id": id })
	                  }).then(function (result) {
	                      $scope.loading = false;

	                      if (result.httpCode == 200) {
	                          toaster.clear('*');
	                          toaster.pop('success', '', "删除成功");

	                          if ($rootScope.pageInfo.data.length == 1 && $scope.param.pageNum > 1) {
	                              $scope.param.pageNum = $scope.param.pageNum - 1;
	                          }
	                          $rootScope.search($scope.url, $scope.param);
	                          //$timeout(function () {
	                          //$rootScope.search($scope.url, $scope.param);
	                          //},800);
	                      } else {
	                          toaster.clear('*');
	                          toaster.pop('error', '', result.msg);
	                      }
	                      $scope.$apply();
	                  });
	              }
	          }
	          // }



	      }]);